<html>

<body>
    <button onclick="generate()">Download document</button>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.16.8/docxtemplater.js"></script>
<script src="https://unpkg.com/pizzip@3.0.6/dist/pizzip.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js"></script>
<script src="https://unpkg.com/pizzip@3.0.6/dist/pizzip-utils.js"></script>
<script>

     var memo_no="memo_no",
      date="date",
      name="name",
      fName="fName",
       mName="mName",
       id="id",
        from_sem="from_sem",
         to_sem="to_sem",
         dept="dept",
          date_of_pass="date_of_pass",
           cgpa="cgpa",
           dp_head="dp_head",
           type="type",
           dp_head_email="dp_head_email";




    function loadFile(url, callback) {
        PizZipUtils.getBinaryContent(url, callback);
    }
    
        function getUrlParameter(sParam) {
            var sPageURL = window.location.search.substring(1),
                sURLVariables = sPageURL.split('&'),
                sParameterName,
                i;

            for (i = 0; i < sURLVariables.length; i++) {
                sParameterName = sURLVariables[i].split('=');

                if (sParameterName[0] === sParam) {
                    return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1].replace(/\+/g, " "));
                }
            }
        };

    function generate() {
      var testimonial="/testimonial.docx";
      var recommendation="";
      var whome="";
      var path;
      if(getUrlParameter(type)=="ts"){
         path=testimonial;
      }else if(getUrlParameter(type) == "rc"){
          path = recommendation;
      }else {
          path = whome;
      }

        loadFile(path, function (error, content) {
            if (error) { throw error };
            var zip = new PizZip(content);
            var doc = new window.docxtemplater().loadZip(zip);
            var dp_head1,dept1,dp_head_email1;
        

            if(getUrlParameter(dept)=="CSE"){
                dept1="Department of Computer Science and Technology (CSE)";
                dp_head1="Al-Imtiaz";
                dp_head_email1="al.imtiaz@uits.edu.bd";
            }else if(getUrlParameter(dept)=="IT"){
                dept1 = "Department of Information Technology (IT)";
                dp_head1 = "Md. Al Shayokh";
                dp_head_email1 = "al.shayokh@uits.edu.bd";
            }
            doc.setData({
                memo_no: getUrlParameter(memo_no),
                date: new Date().toDateString(),
                name: getUrlParameter(name),
                fName:  getUrlParameter(fName),
                mName: getUrlParameter(mName),
                id:  getUrlParameter(id),
                from_sem:  getUrlParameter(from_sem),
                to_sem:  getUrlParameter(to_sem),
                dept: dept1,
                date_of_pass: new Date(getUrlParameter(date_of_pass)).toDateString() ,
                cgpa:  getUrlParameter(cgpa),
                dp_head: dp_head1,
                dp_head_email: dp_head_email1
            });
            try {
                // render the document (replace all occurences of {first_name} by John, {last_name} by Doe, ...)
                doc.render()
            }
            catch (error) {
                // The error thrown here contains additional information when logged with JSON.stringify (it contains a properties object containing all suberrors).
                function replaceErrors(key, value) {
                    if (value instanceof Error) {
                        return Object.getOwnPropertyNames(value).reduce(function (error, key) {
                            error[key] = value[key];
                            return error;
                        }, {});
                    }
                    return value;
                }
                console.log(JSON.stringify({ error: error }, replaceErrors));

                if (error.properties && error.properties.errors instanceof Array) {
                    const errorMessages = error.properties.errors.map(function (error) {
                        return error.properties.explanation;
                    }).join("\n");
                    console.log('errorMessages', errorMessages);
                    // errorMessages is a humanly readable message looking like this :
                    // 'The tag beginning with "foobar" is unopened'
                }
                throw error;
            }
            var out = doc.getZip().generate({
                type: "blob",
                mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
            }) 
            saveAs(out, "output.docx")
        })
    }
</script>

</html>